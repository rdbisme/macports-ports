#-*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               qt5 1.0
PortGroup               cmake 1.1

name                    py-pyside2
version                 5.14.1
revision                0
categories-append       devel aqua python
platforms               darwin
maintainers             {pmetzger @pmetzger} {mcalhoun @MarcusCalhoun-Lopez} openmaintainer
description             Generates bindings for C++ libraries using CPython source code
long_description        ${description}
homepage                https://wiki.qt.io/Qt_for_Python
# see ${worksrcdir}/sources/pyside2/PySide2/licensecomment.txt
license                 {GPL-2 GPL-3+ LGPL-3}
master_sites            https://download.qt.io/official_releases/QtForPython/pyside2/PySide2-${version}-src
distname                pyside-setup-opensource-src-${version}
use_xz                  yes

checksums               rmd160  9e6739c3c222bcce3a689f3d8c9724ca50dd1836 \
                        sha256  41ce931695567639c92acb68a9d66ed5609f067011af9a94b53fc0d697ad1d1c \
                        size    3217008

worksrcdir              ${distname}/sources/pyside2
# Install cmake files in "PySide2" folder, without version
patchfiles-append       patch-cmake-install-dir.diff 

# see https://trac.macports.org/ticket/57517
qt5.min_version     5.8

qt5.depends_component \
    qtxmlpatterns \
    qt3d \
    qtcharts \
    qtdatavis3d \
    qtdeclarative \
    qtgamepad \
    qtlocation \
    qtmacextras \
    qtmultimedia \
    qtremoteobjects \
    qtscript \
    qtscxml \
    qtsensors \
    qtspeech \
    qtsvg \
    qttools \
    qtwebchannel \
    qtwebengine \
    qtwebsockets

 set python_versions         {36 37}
 set python_default_version  37
 
 set llvm_version            9.0

if {${subport} eq ${name}} {
    pre-fetch {
        distfiles
    }
    fetch {}
    pre-checksum {
        distfiles
    }
    checksum {}
    pre-extract {
        distfiles
    }
    extract {}

<<<<<<< HEAD
    destroot.args-append \
        --qmake=${qt_qmake_cmd} \
        --cmake=${prefix}/bin/cmake \
        --skip-cmake \
        --reuse-build

    depends_lib-append \
        port:libxml2 \
        port:libxslt \
        port:py${python.version}-numpy

    qt5.depends_component \
        qtxmlpatterns \
        qt3d \
        qtcharts \
        qtdatavis3d \
        qtdeclarative \
        qtgamepad \
        qtlocation \
        qtmacextras \
        qtmultimedia \
        qtscript \
        qtscxml \
        qtsensors \
        qtspeech \
        qtsvg \
        qttools \
        qtwebchannel \
        qtwebengine \
        qtwebsockets

    if {[vercmp ${qt5.version} 5.9] >=0 } {
        qt5.depends_component \
            qtremoteobjects
     }

    livecheck.type      none
} else {
    livecheck.type      regex
    livecheck.url       https://download.qt.io/official_releases/QtForPython/pyside2/
    livecheck.regex     (\\d+(\\.\\d+)+)
=======
    # set up py-shiboken2 as a stub port that depends on the default pyXY-foo
    depends_lib port:py${python_default_version}[string trimleft $name py]
    configure {}
    patch {}
    build {}
    destroot {
        xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
        system "echo $name is a stub port > ${destroot}${prefix}/share/doc/${name}/README"
    }
>>>>>>> py-pyside2: Use cmake to build
}

 # Generate subports for python versions
 foreach v $python_versions {
     subport py${v}[string trimleft $name py] {
         depends_lib-append  port:python${v}
     }
 }


 if {${name} ne ${subport}} {
     set python_version [string range ${subport} 2 3]
     set python_branch  [string range ${python_version} 0 end-1].[string index ${python_version} end]
     set python_prefix   ${frameworks_dir}/Python.framework/Versions/${python_branch}

     depends_build-append \
         port:py${python_version}-sphinx 
 
     depends_lib-append \
         port:libxslt \
         port:clang-${llvm_version} \
         port:llvm-${llvm_version}
 
     configure.args-append    -DBUILD_TESTS=OFF \
                              -DShiboken2_DIR=${python_prefix}/lib/cmake/Shiboken2 \
                              -DLLVM_CONFIG=${prefix}/bin/llvm-config-mp-${llvm_version} \
                              -DUSE_PYTHON_VERSION=3 \
                              -DPYTHON_EXECUTABLE=${prefix}/bin/python${python_branch} \
                              -DPYTHON_INCLUDE_DIR=${python_prefix}/Headers/ \
                              -DPYTHON_LIBRARY=${python_prefix}/lib/libpython${python_branch}.dylib

    pre-destroot { 
        xinstall -d -m 0755 ${destroot}${python_prefix}/lib
    }

    post-destroot {
        move ${destroot}${prefix}/share ${destroot}${python_prefix}/share
        move ${destroot}${prefix}/include ${destroot}${python_prefix}/include

        move ${destroot}${prefix}/lib/cmake ${destroot}${python_prefix}/lib/cmake
        move ${destroot}${prefix}/lib/pkgconfig ${destroot}${python_prefix}/lib/pkgconfig
        move ${destroot}${prefix}/lib/python${python_branch} ${destroot}${python_prefix}/lib/python${python_branch}
    }
 
     livecheck.type      none
 } 
