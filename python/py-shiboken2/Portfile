#-*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               cmake 1.1

name                    py-shiboken2
version                 5.14.0
revision                0
categories-append       python devel
platforms               darwin
maintainers             {pmetzger @pmetzger} {mcalhoun @MarcusCalhoun-Lopez} openmaintainer
description             Generates bindings for C++ libraries using CPython source code
long_description        ${description}
homepage                https://wiki.qt.io/Qt_for_Python
# see ${worksrcdir}/sources/pyside2/PySide2/licensecomment.txt
license                 {GPL-2 GPL-3+ LGPL-3}
master_sites            https://download.qt.io/official_releases/QtForPython/pyside2/PySide2-${version}-src
distname                pyside-setup-opensource-src-${version}
use_xz                  yes

checksums               rmd160  977e67be9a23148687e7f551155f3a60801a97ba \
                        sha256  8c2ad1901a99165ed7bac8f522ee351ae3ebadd580024248f5a1db52e4a94b30 \
                        size    3203908

worksrcdir              ${distname}/sources/shiboken2
patchfiles              patch-rpath.diff

# Install cmake files in "Shiboken2" folder, without version
patchfiles-append       patch-cmake-install-dir.diff 

 set python_versions         {36 37}
 set python_default_version  37
 
 set llvm_version            9.0

if {${subport} eq ${name}} {
    pre-fetch {
        distfiles
    }
    fetch {}
    pre-checksum {
        distfiles
    }
    checksum {}
    pre-extract {
        distfiles
    }
    extract {}

    # set up py-shiboken2 as a stub port that depends on the default pyXY-foo
    depends_lib port:py${python_default_version}[string trimleft $name py]
    configure {}
    patch {}
    build {}
    destroot {
        xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
        system "echo $name is a stub port > ${destroot}${prefix}/share/doc/${name}/README"
    }
}

 # Generate subports for python versions
 foreach v $python_versions {
     subport py${v}[string trimleft $name py] {
         depends_lib-append  port:python${v}
     }
 }


 if {${name} ne ${subport}} {
     set python_version [string range ${subport} 2 3]
     set python_branch  [string range ${python_version} 0 end-1].[string index ${python_version} end]
     set python_prefix   ${frameworks_dir}/Python.framework/Versions/${python_branch}
 
     PortGroup           qt5 1.0
 
     # see https://trac.macports.org/ticket/57517
     qt5.min_version     5.8
 
     qt5.depends_component \
         qtxmlpatterns
 
     depends_build-append \
         port:py${python_version}-sphinx 
 
     depends_lib-append \
         port:libxslt \
         port:clang-${llvm_version} \
         port:llvm-${llvm_version}
 
     configure.args-append    -DBUILD_TESTS=OFF \
                              -DLLVM_CONFIG=${prefix}/bin/llvm-config-mp-${llvm_version} \
                              -DUSE_PYTHON_VERSION=3 \
                              -DPYTHON_EXECUTABLE=${prefix}/bin/python${python_branch} \
                              -DPYTHON_INCLUDE_DIR=${python_prefix}/Headers/ \
                              -DPYTHON_LIBRARY=${python_prefix}/lib/libpython${python_branch}.dylib

    set destroot_python_prefix ${destroot}/Library/Frameworks/Python.framework/Versions/${python_branch}

    pre-destroot { 
        xinstall -d -m 0755 ${destroot_python_prefix}/lib
    }

    post-destroot {
        move ${destroot}${prefix}/bin/shiboken2 ${destroot}${prefix}/bin/shiboken2-${python_branch}
        move ${destroot}${prefix}/include/shiboken2 ${destroot}${prefix}/include/shiboken2-${python_branch}
        move ${destroot}${prefix}/share/man/man1/shiboken2.1 ${destroot}${prefix}/share/man/man1/shiboken2-${python_branch}.1
        move ${destroot}${prefix}/bin/shiboken_tool.py ${destroot}${prefix}/bin/shiboken_tool-${python_branch}.py
        
        move ${destroot}${prefix}/lib/cmake ${destroot_python_prefix}/lib/cmake
        move ${destroot}${prefix}/lib/pkgconfig ${destroot_python_prefix}/lib/pkgconfig
    }
 
     livecheck.type      none
 } 
